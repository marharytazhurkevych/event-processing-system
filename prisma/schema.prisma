// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model ProcessedEvent {
  id           String   @id @default(cuid())
  eventId      String   @unique
  timestamp    DateTime
  source       String   // "facebook" | "tiktok"
  funnelStage  String   // "top" | "bottom"
  eventType    String
  userId       String
  rawData      Json
  processedAt  DateTime @default(now())
  correlationId String
  
  // Indexes for efficient querying and bulk operations
  @@index([source, timestamp])
  @@index([funnelStage, timestamp])
  @@index([eventType, timestamp])
  @@index([userId, timestamp])
  @@index([timestamp])
  @@index([correlationId]) // For bulk operation tracking
  @@map("processed_events")
}

model EventMetrics {
  id          String   @id @default(cuid())
  service     String   // "gateway", "fb-collector", "ttk-collector", "reporter"
  metricType  String   // "accepted", "processed", "failed", "latency"
  value       Float
  timestamp   DateTime @default(now())
  labels      Json     @default("{}")
  
  @@index([service, metricType, timestamp])
  @@map("event_metrics")
}

model UserDemographics {
  id          String   @id @default(cuid())
  userId      String
  source      String   // "facebook" | "tiktok"
  age         Int?
  gender      String?
  country     String?
  city        String?
  followers   Int?
  username    String?
  name        String?  // For Facebook users
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([userId, source])
  @@index([source, age])
  @@index([source, gender])
  @@index([source, country])
  @@index([userId]) // For bulk upsert operations
  @@map("user_demographics")
}

model RevenueTransaction {
  id          String   @id @default(cuid())
  eventId     String   @unique
  userId      String
  source      String   // "facebook" | "tiktok"
  amount      Decimal  @db.Decimal(10, 2)
  currency    String   @default("USD")
  campaignId  String?
  eventType   String
  timestamp   DateTime
  processedAt DateTime @default(now())
  
  @@index([source, timestamp])
  @@index([campaignId, timestamp])
  @@index([timestamp])
  @@map("revenue_transactions")
}
